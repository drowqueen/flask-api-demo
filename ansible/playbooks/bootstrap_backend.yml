---
- name: Install Python 3.8 on Backend Servers
  hosts: app_servers
  gather_facts: false
  become: true
  vars:
    ansible_user: ec2-user
    ansible_python_interpreter: /usr/bin/python3.8
  tasks:
    - name: Check if bootstrap flag exists
      stat:
        path: /tmp/bootstrap_done_backend
      register: bootstrap_flag_backend

    - name: Ensure python 3.8 is installed if flag is not set
      raw: |
        sudo amazon-linux-extras enable python3.8
        sudo yum clean metadata
        sudo yum install -y python3.8
      when: not bootstrap_flag_backend.stat.exists

    - name: Verify python3.8 installation
      raw: python3.8 --version
      register: python38_version
      when: not bootstrap_flag_backend.stat.exists

    - name: Show python3.8 version
      debug:
        var: python38_version.stdout
      when: not bootstrap_flag_backend.stat.exists

    - name: Create bootstrap flag to prevent re-running bootstrap tasks
      file:
        path: /tmp/bootstrap_done_backend
        state: touch
      when: not bootstrap_flag_backend.stat.exists
